#!/bin/bash
#
# juju-prompt-disable - Display instructions for disabling juju-prompt integration
#

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Detect the user's shell
detect_shell() {
    if [ -n "$BASH_VERSION" ]; then
        echo "bash"
    elif [ -n "$ZSH_VERSION" ]; then
        echo "zsh"
    else
        # Try to detect from parent process
        parent_shell=$(ps -p $PPID -o comm= 2>/dev/null)
        case "$parent_shell" in
            bash) echo "bash" ;;
            zsh) echo "zsh" ;;
            fish) echo "fish" ;;
            *) echo "unknown" ;;
        esac
    fi
}

# Determine the shell directory path
get_shell_dir() {
    if [ -n "$SNAP" ]; then
        # Use 'current' symlink instead of versioned path so it survives updates
        echo "/snap/juju-prompt/current/shell"
    else
        # Running from local installation
        echo "$(dirname "$(readlink -f "$0")")/shell"
    fi
}

main() {
    echo -e "${BLUE}Juju Prompt Shell Integration - Disable${NC}"
    echo ""

    SHELL_TYPE=$(detect_shell)
    SHELL_DIR=$(get_shell_dir)

    if [ "$SHELL_TYPE" = "unknown" ]; then
        echo -e "${YELLOW}Could not detect your shell automatically.${NC}"
        echo ""
        echo "To disable juju-prompt, remove the source line from your shell configuration:"
        echo "  - Bash:  Remove 'source $SHELL_DIR/bash' from ~/.bashrc"
        echo "  - Zsh:   Remove 'source $SHELL_DIR/zsh' from ~/.zshrc"
        echo "  - Fish:  Remove 'source $SHELL_DIR/fish' from ~/.config/fish/config.fish"
        exit 0
    fi

    echo -e "Detected shell: ${GREEN}$SHELL_TYPE${NC}"
    echo ""

    case $SHELL_TYPE in
        bash)
            CONFIG_FILE="$HOME/.bashrc"
            SOURCE_LINE="source $SHELL_DIR/bash"
            RELOAD_CMD="source $HOME/.bashrc"
            ;;
        zsh)
            CONFIG_FILE="$HOME/.zshrc"
            SOURCE_LINE="source $SHELL_DIR/zsh"
            RELOAD_CMD="source $HOME/.zshrc"
            ;;
        fish)
            CONFIG_FILE="$HOME/.config/fish/config.fish"
            SOURCE_LINE="source $SHELL_DIR/fish"
            RELOAD_CMD="Restart your Fish shell"
            ;;
        *)
            echo -e "${YELLOW}Unsupported shell: $SHELL_TYPE${NC}"
            exit 1
            ;;
    esac

    echo -e "${YELLOW}To disable juju-prompt, remove this line from $CONFIG_FILE:${NC}"
    echo ""
    echo -e "  ${GREEN}$SOURCE_LINE${NC}"
    echo ""
    echo -e "${BLUE}Then reload your shell:${NC}"
    echo -e "  ${YELLOW}$RELOAD_CMD${NC}"
    echo ""
}

main
