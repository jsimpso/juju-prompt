#!/bin/bash
#
# juju-prompt-enable - Display instructions for enabling juju-prompt integration
#

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Detect the user's shell
detect_shell() {
    if [ -n "$BASH_VERSION" ]; then
        echo "bash"
    elif [ -n "$ZSH_VERSION" ]; then
        echo "zsh"
    else
        # Try to detect from parent process
        parent_shell=$(ps -p $PPID -o comm= 2>/dev/null)
        case "$parent_shell" in
            bash) echo "bash" ;;
            zsh) echo "zsh" ;;
            fish) echo "fish" ;;
            *) echo "unknown" ;;
        esac
    fi
}

# Determine the shell directory path
get_shell_dir() {
    if [ -n "$SNAP" ]; then
        # Use 'current' symlink instead of versioned path so it survives updates
        echo "/snap/juju-prompt/current/shell"
    else
        # Running from local installation
        echo "$(dirname "$(readlink -f "$0")")/shell"
    fi
}

main() {
    echo -e "${BLUE}Juju Prompt Shell Integration${NC}"
    echo ""

    SHELL_TYPE=$(detect_shell)
    SHELL_DIR=$(get_shell_dir)

    if [ "$SHELL_TYPE" = "unknown" ]; then
        echo -e "${YELLOW}Could not detect your shell automatically.${NC}"
        echo ""
        echo "Available integrations:"
        echo "  - Bash:  source $SHELL_DIR/bash"
        echo "  - Zsh:   source $SHELL_DIR/zsh"
        echo "  - Fish:  source $SHELL_DIR/fish"
        echo ""
        echo "Add the appropriate line to your shell's configuration file."
        exit 0
    fi

    echo -e "Detected shell: ${GREEN}$SHELL_TYPE${NC}"
    echo ""

    case $SHELL_TYPE in
        bash)
            CONFIG_FILE="\$HOME/.bashrc"
            SOURCE_LINE="source $SHELL_DIR/bash"
            # shellcheck disable=SC2016
            PROMPT_EXAMPLE='PS1="${PS1}\$(juju_ps1) "'
            RELOAD_CMD="source ~/.bashrc"
            ;;
        zsh)
            CONFIG_FILE="\$HOME/.zshrc"
            SOURCE_LINE="source $SHELL_DIR/zsh"
            # shellcheck disable=SC2016
            PROMPT_EXAMPLE='PROMPT="${PROMPT}\$(juju_ps1) "'
            RELOAD_CMD="source ~/.zshrc"
            ;;
        fish)
            CONFIG_FILE="\$HOME/.config/fish/config.fish"
            SOURCE_LINE="source $SHELL_DIR/fish"
            PROMPT_EXAMPLE="Edit ~/.config/fish/functions/fish_prompt.fish and add (juju_ps1)"
            RELOAD_CMD="Restart your Fish shell"
            ;;
        *)
            echo -e "${YELLOW}Unsupported shell: $SHELL_TYPE${NC}"
            exit 1
            ;;
    esac

    echo -e "${GREEN}Step 1: Source the juju-prompt integration${NC}"
    echo -e "Add this line to your $CONFIG_FILE:"
    echo ""
    echo -e "  ${YELLOW}$SOURCE_LINE${NC}"
    echo ""
    echo -e "${GREEN}Step 2: Add juju_ps1 to your prompt${NC}"
    if [[ "$SHELL_TYPE" == "fish" ]]; then
        echo -e "${YELLOW}$PROMPT_EXAMPLE${NC}"
    else
        echo -e "Add \$(juju_ps1) to your existing PS1/PROMPT. For example:"
        echo ""
        echo -e "  ${YELLOW}$PROMPT_EXAMPLE${NC}"
    fi
    echo ""
    echo -e "${GREEN}Step 3: Reload your shell${NC}"
    echo -e "  ${YELLOW}$RELOAD_CMD${NC}"
    echo ""
    echo -e "${BLUE}Toggle commands (available after sourcing):${NC}"
    echo -e "  ${YELLOW}juju-prompt-on${NC}      - Enable for this session"
    echo -e "  ${YELLOW}juju-prompt-off${NC}     - Disable for this session"
    echo -e "  ${YELLOW}juju-prompt-off -g${NC}  - Disable globally (persists)"
    echo -e "  ${YELLOW}juju-prompt-on -g${NC}   - Re-enable globally"
    echo ""
    echo -e "${BLUE}Customization:${NC}"
    if [ -n "$SNAP" ]; then
        echo -e "  Model colors can be customized by editing:"
        echo -e "  ${YELLOW}~/snap/juju-prompt/common/colors.conf${NC}"
        echo ""
        echo -e "  This file is auto-created on first run with default patterns."
        echo -e "  Example config also available at:"
        echo -e "  ${YELLOW}$SNAP/examples/colors.conf${NC}"
    else
        echo -e "  Model colors can be customized by editing:"
        echo -e "  ${YELLOW}~/.config/juju-prompt/colors.conf${NC}"
        echo ""
        echo -e "  This file is auto-created on first run with default patterns."
    fi
    echo ""
    echo -e "  Example patterns:"
    echo -e "    ${YELLOW}^production.*:red${NC}        # Production models in red"
    echo -e "    ${YELLOW}.*critical.*:bright_red${NC}  # Critical models in bright red"
    echo -e "    ${YELLOW}^staging.*:yellow${NC}        # Staging models in yellow"
    echo ""
}

main "$@"
